class DBHelper{constructor(){this._dbPromise}static get DATABASE_URL(){return"http://localhost:1337/"}static openIDB(){this._dbPromise=idb.open("part3",1,function(t){t.createObjectStore("restaurants",{keyPath:"id"}),t.transaction.objectStore("restaurants").createIndex("is_favorite","is_favorite"),t.createObjectStore("reviews",{keyPath:"id"}),t.transaction.objectStore("reviews").createIndex("restaurant_id","restaurant_id"),t.createObjectStore("syncReviews",{keyPath:"createdAt"})})}static getRestaurantsFromDB(t){this._dbPromise.then(t=>{if(!t)return;return t.transaction("restaurants","readwrite").objectStore("restaurants").getAll()}).then(e=>t(null,e)).catch(e=>t(e,null))}static putRestaurantsToDB(t){this._dbPromise.then(e=>{if(!e)return;const r=e.transaction("restaurants","readwrite").objectStore("restaurants");Array.isArray(t)?t.forEach(t=>{r.get(parseInt(t.id)).then(e=>{(!e||t.updatedAt>e.updatedAt)&&r.put(t)})}):r.put(t)}).catch(t=>console.log("Error Adding Restaurants to DB:",t))}static putReviewsToDB(t){this._dbPromise.then(e=>{if(!e)return;const r=e.transaction("reviews","readwrite").objectStore("reviews");Array.isArray(t)?t.forEach(t=>r.put(t)):r.put(t)}).catch(t=>console.log("Error Adding Reviews to DB:",t))}static saveReviews(t){this._dbPromise.then(e=>{if(!e)return;e.transaction("syncReviews","readwrite").objectStore("syncReviews").put(t)}).catch(t=>console.log("Error Saving Review to DB:",t))}static sendSavedReviews(t){this._dbPromise.then(t=>{if(!t)return;return t.transaction("syncReviews","readwrite").objectStore("syncReviews").openCursor()}).then(function t(e){if(e)return DBHelper.postRestaurantReview(e.value,(t,e)=>{e||console.error(t)}),e.delete(),e.continue().then(t)}).catch(t=>console.log("Error Saving Review to DB:",t))}static fetchRestaurants(t,e){const r=DBHelper.DATABASE_URL+"restaurants",n=e?`${r}/${e}`:r;fetch(n).then(e=>{e&&200===e.status?e.json().then(e=>{DBHelper.putRestaurantsToDB(e),t(null,e)}):t("No Restaurants Found",null)}).catch(e=>{t(`Request failed with following error: ${e}`,null)})}static updateRestaurantFavorite(t,e){const r=`${DBHelper.DATABASE_URL}restaurants/${t.id}/?is_favorite=${t.is_favorite}`;fetch(r,{method:"PUT"}).then(t=>{t&&200===t.status?t.json().then(t=>{DBHelper.putRestaurantsToDB(t),e(null,t)}):e("Error Updating Favorite",null)})}static getFavoriteRestaurants(t){const e=`${DBHelper.DATABASE_URL}restaurants/?is_favorite=true`;this._dbPromise.then(t=>{if(!t)return;return t.transaction("restaurants").objectStore("restaurants").index("is_favorite").getAll("true")}).then(r=>{if(r.length>0){const e=[];for(let t of r)e.push(t.id);t(null,e)}else fetch(e).then(e=>{e&&200===e.status?e.json().then(e=>{const r=[];for(let t of e)r.push(t.id);DBHelper.putRestaurantsToDB(e),t(null,r)}):t("No Favorites Found",null)}).catch(e=>{t(`Request failed with following error: ${e}`,null)})})}static postRestaurantReview(t,e){const r=`${DBHelper.DATABASE_URL}reviews/`;fetch(r,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(t)}).then(t=>{t&&201===t.status?t.json().then(t=>{DBHelper.putReviewsToDB(t),e(null,t)}):e("Something went wrong",null)}).catch(t=>{e(`Request failed with following error: ${t}`,null)})}static fetchRestaurantReviews(t,e){var r=!1;const n=`${DBHelper.DATABASE_URL}reviews/?restaurant_id=${t}`;fetch(n).then(t=>{t&&200===t.status?t.json().then(t=>{DBHelper.putReviewsToDB(t),r=!0,e(null,t)}):e("No Reviews Found",null)}).catch(t=>{e(`Request failed with following error: ${t}`,null)});this._dbPromise.then(e=>{if(!e)return;return e.transaction("reviews").objectStore("reviews").index("restaurant_id").getAll(parseInt(t))}).then(t=>{t.length>0&&!r&&e(null,t)})}static fetchRestaurantById(t,e){this._dbPromise.then(e=>{if(!e)return;return e.transaction("restaurants").objectStore("restaurants").get(parseInt(t))}).then(r=>{r?e(null,r):DBHelper.fetchRestaurants((t,r)=>{t?e(t,null):e(null,r)},t)}).catch(t=>e(t,null))}static fetchRestaurantByCuisine(t,e){DBHelper.fetchRestaurants((r,n)=>{if(r)e(r,null);else{const r=n.filter(e=>e.cuisine_type==t);e(null,r)}})}static fetchRestaurantByNeighborhood(t,e){DBHelper.fetchRestaurants((r,n)=>{if(r)e(r,null);else{const r=n.filter(e=>e.neighborhood==t);e(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(t,e,r){DBHelper.getRestaurantsFromDB((n,o)=>{if(n)r(n,null);else{let n=o;"all"!=t&&(n=n.filter(e=>e.cuisine_type==t)),"all"!=e&&(n=n.filter(t=>t.neighborhood==e)),r(null,n)}})}static fetchNeighborhoods(t){DBHelper.fetchRestaurants((e,r)=>{if(e)t(e,null);else{const e=r.map((t,e)=>r[e].neighborhood),n=e.filter((t,r)=>e.indexOf(t)==r);t(null,n)}})}static fetchCuisines(t){DBHelper.getRestaurantsFromDB((e,r)=>{if(e)t(e,null);else{const e=r.map((t,e)=>r[e].cuisine_type),n=e.filter((t,r)=>e.indexOf(t)==r);t(null,n)}})}static urlForRestaurant(t){return`./restaurant.html?id=${t.id}`}static imageUrlForRestaurant(t){return`/images/${t.id}-480_medium.jpg`}static mapMarkerForRestaurant(t,e){return new google.maps.Marker({position:t.latlng,title:t.name,url:DBHelper.urlForRestaurant(t),map:e,animation:google.maps.Animation.DROP})}}"use strict";!function(){function t(t){return new Promise(function(e,r){t.onsuccess=function(){e(t.result)},t.onerror=function(){r(t.error)}})}function e(e,r,n){var o,s=new Promise(function(s,i){t(o=e[r].apply(e,n)).then(s,i)});return s.request=o,s}function r(t,e,r){r.forEach(function(r){Object.defineProperty(t.prototype,r,{get:function(){return this[e][r]},set:function(t){this[e][r]=t}})})}function n(t,r,n,o){o.forEach(function(o){o in n.prototype&&(t.prototype[o]=function(){return e(this[r],o,arguments)})})}function o(t,e,r,n){n.forEach(function(n){n in r.prototype&&(t.prototype[n]=function(){return this[e][n].apply(this[e],arguments)})})}function s(t,r,n,o){o.forEach(function(o){o in n.prototype&&(t.prototype[o]=function(){return t=this[r],(n=e(t,o,arguments)).then(function(t){if(t)return new a(t,n.request)});var t,n})})}function i(t){this._index=t}function a(t,e){this._cursor=t,this._request=e}function u(t){this._store=t}function c(t){this._tx=t,this.complete=new Promise(function(e,r){t.oncomplete=function(){e()},t.onerror=function(){r(t.error)},t.onabort=function(){r(t.error)}})}function l(t,e,r){this._db=t,this.oldVersion=e,this.transaction=new c(r)}function h(t){this._db=t}r(i,"_index",["name","keyPath","multiEntry","unique"]),n(i,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(i,"_index",IDBIndex,["openCursor","openKeyCursor"]),r(a,"_cursor",["direction","key","primaryKey","value"]),n(a,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(a.prototype[e]=function(){var r=this,n=arguments;return Promise.resolve().then(function(){return r._cursor[e].apply(r._cursor,n),t(r._request).then(function(t){if(t)return new a(t,r._request)})})})}),u.prototype.createIndex=function(){return new i(this._store.createIndex.apply(this._store,arguments))},u.prototype.index=function(){return new i(this._store.index.apply(this._store,arguments))},r(u,"_store",["name","keyPath","indexNames","autoIncrement"]),n(u,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(u,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(u,"_store",IDBObjectStore,["deleteIndex"]),c.prototype.objectStore=function(){return new u(this._tx.objectStore.apply(this._tx,arguments))},r(c,"_tx",["objectStoreNames","mode"]),o(c,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new u(this._db.createObjectStore.apply(this._db,arguments))},r(l,"_db",["name","version","objectStoreNames"]),o(l,"_db",IDBDatabase,["deleteObjectStore","close"]),h.prototype.transaction=function(){return new c(this._db.transaction.apply(this._db,arguments))},r(h,"_db",["name","version","objectStoreNames"]),o(h,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(t){[u,i].forEach(function(e){t in e.prototype&&(e.prototype[t.replace("open","iterate")]=function(){var e,r=(e=arguments,Array.prototype.slice.call(e)),n=r[r.length-1],o=this._store||this._index,s=o[t].apply(o,r.slice(0,-1));s.onsuccess=function(){n(s.result)}})})}),[i,u].forEach(function(t){t.prototype.getAll||(t.prototype.getAll=function(t,e){var r=this,n=[];return new Promise(function(o){r.iterateCursor(t,function(t){t?(n.push(t.value),void 0===e||n.length!=e?t.continue():o(n)):o(n)})})})});var p={open:function(t,r,n){var o=e(indexedDB,"open",[t,r]),s=o.request;return s&&(s.onupgradeneeded=function(t){n&&n(new l(s.result,t.oldVersion,s.transaction))}),o.then(function(t){return new h(t)})},delete:function(t){return e(indexedDB,"deleteDatabase",[t])}};"undefined"!=typeof module?(module.exports=p,module.exports.default=module.exports):self.idb=p}();